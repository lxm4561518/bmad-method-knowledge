{
  "title": "【IT老齐004】为什么架构师对多级缓存架构情有独钟？",
  "content": "在开始之前如果觉得内容不错麻烦点一个赞点赞超过13个马上进行下一期的更新在这儿老奇拜托大家了那好 咱们现在直接进入今天的主题为什么加购师对多极换存加购都情有独中呢本角咱们将涉及三方面内容第一 要去讲解在外部应用的客户端换存第二 应用层的静态资源换存第三 服务层的多极换存那么提到换存想必每一位工程师应该都不陌生他是目前加购设计中提升性能最直接的方法我们举个例子假设应用程序将原始数据存放在买塞货数据库中众所周知买塞货数据库会将数据存储在硬盘上以防止标淡丢失但是受质于硬盘的物理设计即便是目前性能最好的企业级的SS硬盘也比内存这种高速设备在IO层面上差一个数量级而以淘宝京东这种电商为代表的互联网用又是典型的独多协少的场景因此我们需要在设计上进行数据的独协分离在数据协入的时候直接进行落盘处理而超过90%的独取操作时则要通过以Redis为代表的内存型能塞货数据库来进行数据体取利用内存的高吞土特性来瞬间完成数据的操作这里Redis的作用就是我们常说的换存了当然了换存可不是只有用内存替代硬盘的一种方式在分布式的架构下每一层都有自己的设计下面我们就通过这张多级换存的架构图为主线暗层来讲解每一层要进行哪些换存操作那么从这张图从上到下应该分为四层分别是客户端应用层服务层以及数据层首先咱们要说客户端换存假设我们商城客户端是榴栏器在榴栏器层面主要是对HTML中图片CSSJS自体这些静态资源来进行换存我们以百度Logo图片为例百度在HTDP通过XPERS显投控制静态图片的有效期XPERS代表过期时间当前百度Logo的过期时间为2031年2月8日9026分31秒在这个时间段内榴栏器会将图片以文件形式保存到本地再次访问时会看到FromDiskCache的提示此时榴栏器不再产生实际与服务器的请求而直接从本地将图片读取就好了通过在榴栏器端设置XPERS可以很大程度上减少重复请求静态资源带来的贷宽损号这在高并发外面用中是基础而重要的设置作为客户端换存只需要进行文件换存就可以了下面重头细就是应用层的换存刚才我们提到的XPERS到底在哪设置呢对于榴栏器来说它只是一个客户端只负责读取XPERS想用头对于XPERS要在应用层也就是CDN与NGIC的使用来进行设置CDN内容分发网络全成为Content Delivery Network及内容非发网络是互联网静态资源分发的主要技术手段要知道中国服务员聊祸从北京到上海就会有上千公里如果大量的上海用户同时要访问千里之外的北京服务资源这么长的通信必然会带来高延迟和更多不可控的因素如果有某种机制能够将北京的静态文件换存到上海的服务器上海用户自动旧境访问服务器或得这些静态资源这样便可以很大程度上的降低我们网络的延迟近尔提高系统的可用性而刚才提到的分布是换存技术就是我们常用到的CDN内容分发网络了对于广域的互联网用用CDN几乎是基础设施它有效解决了贷宽集中占用以及数据分发的问题像咱们网页中的图片业视频CSS,GS这些静态资源都是可以通过CDN来进行旧境获取的而CDN的核心技术就是咱们当前看到的智能DNS智能DNS会根据用户的IP自动旧境访问CDN节点以某上海用户的流暖器要访问X双层首页广告卫的班纳点JPJ文件流暖器会通过服务提供商的智能DNS服务将请求自动转发在X双层在上海区域准备的CDN服务器上海CDN服务器收到请求后首先检测本机有没有缓存过这张图片如果这张图片已经被缓存过了直接拿出来对客户端返回就可以了如果没有缓存过则进行回员访问北京的元数据节点将这个图片文件超取到上海的服务器再由上海的CDN节点对其进行返回对于这张图片来说第一次访问后上海的CDN节点自然就爆流了该文件之后上海用户访问就直接就进的进行文件提取就可以了那注如此类的如果全中国各地都安排了这些CDN节点的话是不是就可以有效地将北京服务器的请求分摊到各个其他CDN节点上从而降低了北京机房的贷宽压力在互联网院用中因为CDN涉及到多预多节点的组网前期的投入应该是很高的很多中小型公司他们没有这种材力他就会选择利用阿里云腾讯云华为云这样的大厂提供的CDN服务来进行作用按照年付费的方式或者流量付费的方式来进行一个付费和使用那么就以阿里云腾讯云的CDN服务为例除了缓存文件之外我们还可以在后台为其设置缓存的属性比如刚才提到的Xperiax响应头或者KHK响应头那么这里我还有是有必要说明一下的很多人在进行外部应用开发的时候是分布清Xperiax响应头和KHK有什么区别的其实这两项都是通知客户断流暖气来进行缓存的只不过作为Xperiax他是要指定具体某个时间点缓存到期而KHK则代表缓存这个文件采用多长时间Xperia是设置时间KHKK是设置时长我们根据不同的业务场景使用不同的响应头以上便是CDN内容分发他起到的作用下面咱们要再看一看NGX一般来说说到CDN就不得不了NGXNGX是一款开源的画平台的高性能外部服务器如果你是一个高级程序员肯定对NGX是非常熟悉的了那么NGX作为外部应用价格中的长客例如后端的他们开的集权便可以通过NGX做前置的软副代军侯为应用提供高可用性在我们互联网应用中用户它往往分布在全国各地对资源的显用速度和贷宽要求是比较高的因此我们通常会选择CDN来进行内容分发但是采很多企业集应用往往这些企业用户是分布在指定的办公区域或者相对固定的场所再加上并发的用户相对较少其实并不需要去额外部署像CDN这样的重量级的解决方案在我们价购中往往只需要单独的部署一台NGX服务器利用NGX自带的静态资源缓存的能力以及压速的功能就可以生任局大多数的企业集的应用场景了那么作为NGX来说如果你要去使用它的缓存功能只需要在它的核心配置文件NGX得儿考费个中增加以下片段便可以对静态资源进行缓存关现在代码我已经做好诸势放在了课程的附件中同学们可以自行的下载获取那么作为NGX对文件缓存以后它实际上是在本地用一个一个目录的方式来进行的组织可以看到当前我缓存的这些图片文件CSS,GSS都在NGX的缓存目录下来进行分目录分文件的保存了在这个缓存的有效期内静态资源就不在直接在NGX上读取并返回对于刚才我们的讲解无论是CDN还是NGX其实都是对外北应用中的静态资源来进行缓存的但是后端的应用和服务更多的时候是访问接口以及提供数据对于这些对象我们如何利用缓存技术来进行优化呢在这里我们就要去聊一聊服务层的缓存了对于服务层缓存来说我们又可以细化为进程内缓存和进程外缓存所谓进程外缓存其实就是通常说的分布是缓存典型代表就是Redis那么作为进程内缓存顾名思义就是在一个应用中开批一段内存空间数据是在运行时被载入到这款内存中通过本地内存的低延迟高吞吐特性来提高程序的访问速度进程内缓存在众多的扎格框枕中也有着典型的应用比如说Hipbernate,Mybatties的12级缓存Spring MUSE的业面缓存都是进程内缓存的典型代表这些进程内缓存在扎娃也有着很多开源的实现比如说有EHK,Kafein这些代表性的产品那么除此以外分布是缓存可以说是几乎每一个大型应用都会应用到的作为分布是缓存是与进程内缓存相对的就是通过独立的部署分布是缓存服务最常用的就是基于Ralis的这种内存型Nosecord数据库对整体加高中的应用数据来进行集中缓存在加高设计时很多加高时一听到缓存下一声就认为加一个Ralis不就可以了吗其实这是非常片面的理解因为在我们进行加高设计的时候缓存一定要按照先进到远由快到慢的顺序来进行主义访问我们假设个场景X变商在进行商品秒杀的时候如果没有本地缓存所有商品定单物流的热点数据都被保寒在了Ralis的服务器中当我们每完成一笔数据的交互时其实都要额外的通过局域网产生弱干次的网络通信网络通信本身就可能会存在一些顾掌或者通信失败的风险其实你能够保重网络是百分之百可用的前提下但是Ralis集群成在了所有节点的访问压力一旦突发的流量超过了Ralis的融载上线的话我们整个价购就可能会面临着崩溃的风险因此在渣达的应用端也要设计多极应用换存我们通过进程内换存和分布式换存相结合的方式有效地分贪这个压力在渣达应用方面只有EHK是换存不存在的时候采取Ralis分布式换存进行独取如果Ralis也没有这个数据我们再到数据库进行查询数据库查询成功后对Ralis以及EHK是来进行双写更新这样下一次渣达应用再次查询相同数据的时候就直接从进程内的本地内存中来进行提取就不会产生新的网络通信应用的性能就可以得到显住的提升但是刚才的设计是无完美当引入了多极换存以后我们又会遇到一些换存数据一致性的挑战以下图为例我们都知道作为数据库写操作是不会走换存的假设商品服务实力一将EHK产品价格调整为80元这样就会衍生出一个新问题如何主动向应用程序推送数据辩功的消息来保证它的换存也能同步更新此时你可能已经有了自己的答案最常见的做法是我们只需要在当前的价格中引入MQ消息队列利用RocketMQRabbitMQ卡福卡的这些主动推送的功能向其他的服务实力来推送这些辩功的数据那么如上途所事在商品服务E对价格调整后主动向RocketMQBrowker发送了一个辩功消息Browker将辩功的消息推送到其他的实力以及Redis的集群这些服务实力收到消息以后在换存中先将这些换存删除然后再进行重新的创建以此来保重各实力的数据一致那么看到这里你会发现对于换存来说其实并没有中期的几句方案虽然多计换存会带来更好的应用性能但是引入换存后也必然会增加一致性的问题那为了解决一致性问题我们又要增加MQ或者其他的这种一致性的组件这必然也会增加架构的复杂度让我们出问题的概率会变得增大那对于架构是来说到底什么时候要进行多论击换存的引入和设计呢我总结了有三种情况是最合适不过的了第一种情况是换存的数据是稳定的比如说游政编码地狱区块归党的历史数据这些信息都是非常适合利用多计换存来减小Readyce和数据库压力的第二种情况是瞬间可能会产生极高病发的场景比如说咱们123.0有冲印受票双十一的整点秒杀股市开盘的交易这些瞬间的流量缝值可能会激垮我们的Readyce以及数据库产生流浪选丰那么为了解决机器的问题我们可以在应用启动的时候对这些热点数据进行一个预热的处理也就是说在实际访问之前我们先把热点数据先分谈到每一个客户端进行换存这样就可以有效的减少来自于后端的压力了而第三种情况就是在一定程度上我们可以也允许引入缓存以后数据不一致比如说博客平台你修改了自我介绍这样的非关键性的信息此时的应用机寻中其他节点的缓存你即使没空心其实也不会造成太大的影响大不了就是别人看不到你的最近消息而已吗那么对于这种情况我们如何不救呢比如说可以通过T加E的方式采用一天要日中处理来把这个数据进行一个补权就可以了那么以上三种情况是我们在实际项目用用时最常见的一些案例和长久你也可以思考一下在你的当前的项目和架构中有没有可以加入多极缓存的必要好的那么讲到这里涉及到多极缓存的知识我给大家进行了介绍具体在应用过程中我们如何实现多极缓存我想在后期针对于这个路纸抽一个完整搭建多极缓存的这么一个过程让大家也学有所用看到这里的肯定都是真爱粉了那么麻烦给点个赞谢谢大家",
  "url": "https://www.bilibili.com/video/BV1Lq4y1975x?spm_id_from=333.788.videopod.sections&vd_source=65ed214bc3bc9271284d90d5a82986db",
  "timestamp": "2025-12-17T09:56:29.280268"
}