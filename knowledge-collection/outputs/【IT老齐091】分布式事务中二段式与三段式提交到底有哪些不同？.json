{
  "title": "【IT老齐091】分布式事务中二段式与三段式提交到底有哪些不同？",
  "content": "说人话 重视战讲安慌你好 欢迎来到IT老奇的架构300奖我是你们的IT私人顾问老奇兄弟们的支持是老奇更新最大的动力这里另一个小目标 硬幣加收藏 过300老奇立即报干更新下一期的内容老奇到现在已经工作18年了一直在从事扎罢于加购严发的工作今年是我内容创业的第一年目前我已经录制了有上百个小时的加购与编程方面的内容同时还可以为大家提供点对点的检例优化模拟面试职业规划解决方案加购职导等服务总之 只要是我有情愿的能够对你有用的信息我一定开成不公有需要的些伙伴可以看一下评论区 或者我的个人介绍希望用我的经验能够帮你找到更好的工作有着更高的收入好的 那我们开始今天的内容今天我们来用说人话案例的方式来讲解一下在分布式加购下二段式提交和三段式提交到底有什么区别下面咱们先聊一下为什么会产生分布式事务咱们举个例子某些上传会员在购面商品的同时产生相应的消费机分消费机分在下一次勾勿时和底容现心这个业务的逻辑如果放在以前的单点应用是很简单的如下所事在这个过程中因为程序操作的是单点数据库所以在一个数据库事务中便可完成所有操作利用数据库自带的原子性保证了所有数据要么全部处理成功要么全部回滚车销但是放在以微服务为代表的分布式加购下问题就没有那么简单了我们来看一下试一图可以看到商城应用作为业务的发期者分别向定单会员互存服务发起了调用而这些服务有拥有自己独立的数据存储因为在物理上各个数据库服务器都是独立的每一个部制的操作都会创建独立的事务这就意味着在分布式失务处理时无法通过单点数据库利用一个失务保证数据的完整性我们必须引入某种额外的机制来协调多个失务要么全部提交要么全部回滚以此保证数据的完整性这就是分布式失务的由来在分布式加购中有两种经典的分布式失务解决方案二阶段提交与三阶段提交首先咱们分析下二阶段提交的处理过程下面是二阶段提交的第一个阶段失务与处理阶段相比单点失务分布式失务中增加了一个新的角色失务协调者它的职责是协调各个分支失务的开启与提交回滚的处理以上途为例定单创建后首先失务协调者会向各服务下达处理本地失务的通知所谓本地失务就是每个服务应该做的事情如定单服务负责创建新的定单纪录会员服务负责灯加会员的继分互存服务负责减少互存在这个阶段被操作的所有数据都处于未提交的状态会被排他所所定当本地失务都处理完成后会通知失务协调者本地失务处理完毕当失务协调者陆续收到定单会员互存服务的处理完毕通知后便进入二阶段提交阶段在提交阶段失务处理者会向每一个服务下达提交命令每个服务收到提交命令后在本地失务中对阶段一未提交的数据卡密特提交已完成数据最终的协入之后服务便向失务协调者上报提交成功的通知当失务协调者收到所有服务提交成功的通知后就意味着一次分布式失务处理一成功这便是二阶段提交的正常执行过程但假设在阶段一有任何一个服务一某种原因向失务协调者上报失务处理失败就意味着整体业务处理出现问题阶段二的操作就自动改为回滚处理将所有未提交的数据撤销使数据还原以保证完整性对于二阶段提交来说他有一个致命问题当阶段二某个服务因为网络原因无法收到协调者下达的提交命令则未提交的数据就会被尝试监组色可能导致系统蒙馈以上途为例如果在提交阶段库存服务实力与失务协调者之间断网提交指令无法下达这会导致库存中非科替续刀商品库存记录会长期处于未提交的状态因为这条记录被数据库排他所长期独占之后再有其他现成要访问非科替续刀库存数据该现成就会长期处于组色状态随着组色现成的不断增加库存的服务会面临崩溃的风险这个问题要怎么解决呢其实只要在服务这一侧增加超时机制过一段时间被锁定的非科替续刀因超时自动执行提交操作释放锁定资源尽管这样做会导致数据不一致但也比现成鸡丫导致服务崩溃要好出于此目的三階段提交变应云而生三階段提交十字是将二階段中的提交階段拆分为预提交階段与提交階段同时在服务端都引入超时机制保证数据护资源不会被长时间锁定下面是三階段提交的失益过程階段一事务预处理階段三PC的事务预处理階段与二PC是一样的用于处理本地事务锁定数据顾资源当所有服务返回成功后进入鸡段二鸡段二预提交階段预提交階段只是一个询问机制以确认所有服务都以准备好同时此阶段协调者与参议者都设置了超时时间以防止出现长时间资源锁定当鸡段二所有服务返回可以提交进入鸡段三提交階段鸡段三提交階段三PC的提交階段与二PC的提交階段是一致的在每一个数据顾中执行提交实现数据的资源协入如果协调者与服务通信中段导致无法提交在服务端超时后也会自动执行提交操作来保证资源释放通过对比我们发现三階段提交是二階段提交的优化版本主要通过加入与提交階段引入超时期制让数据顾不会被长期锁定但这也带来一个新问题数据一致性也很可能因为超时后的强制提交被破坏对于这个问题各大二软件公司都在各显神通常见的做法有增加异部的数据补常任务日中跑批前的数据补常更完善的业务数据完整性的交易代码引入数据监控即时通知人工补露这些都是不错的不就措施讲到这儿相比你对RPC与三PC的分布式事务方案应该有了初步的了解这里我还是要强调下无论是RPC与三PC都是一种方案是一种宏观的设计如果要落地就要一拖具体的软件产品下一节课我们就以著名的阿里巴巴Cita为切入点为大家讲解分布式事务具体的落地过程和直情原理",
  "url": "https://www.bilibili.com/video/BV1S44y1577t?spm_id_from=333.788.videopod.sections&vd_source=65ed214bc3bc9271284d90d5a82986db",
  "timestamp": "2025-12-17T09:52:40.675512"
}